<!doctype html>
<html>
  <head>
    <title>Test Session Main Page</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.js"></script>
  </head>

  <div id="container">
    <p id="sessionTitle">Session page placeholder</p>
    <p id="plan">Test plan: </p>
    <p id="embeddedVersion">Embedded version: </p>
    <p id="testVersion">Test version: </p>
    <p id="status">Status</p>
    <p id="activeSetups">Currently active setup functions: None</p>

    <p id="running">Running - module: class: test: phase:</p>
    <p id="complete">Last completed: </p>
    <div id="testResults">

    </div>
  </div>

  <script type="text/javascript">
    $(window).ready(function() {
      let socket = io();
      socket.on('connect', function () {
        console.log("Client connected");
        socket.emit('from', {page: 'session'});
      });

      socket.on('session_full', (data) => {
        console.log(data);
        console.log('Collected tests: ' + data.collected);
        console.log('Collected tests #: ' + data.collected.length);
        $('#sessionTitle').html('Session ' + data.sessionId + ' collected ' +
          data.collected.length + ' tests');
        $('#plan').html('Test plan: ' + data.plan);
        $('#status').html('Status: ' + data.status);

      });

      socket.on('session_update', (data) => {
        console.log(data);
        if (data.hasOwnProperty('updatedFields')) {
          // TODO process this at the server end instead - just for array elements like runOrder
          Object.entries(data.updatedFields).forEach(function(k) {
            if (k[0].indexOf('runOrder') === 0) {
              // attribute starts with runOrder
              console.log("Found - " + k[0]);
              console.log(k);
              if (k[1] instanceof Array) {
                // for the first entry [0] object is in an array
                $('#testResults').append('<p>' + k[1][0].testName +'</p>');
              } else {
                $('#testResults').append('<p>' + k[1].testName +'</p>');
              }
            }
            if (k[0] === 'progress.phase') {
              $('#running').html('Running - module: class: test: phase: ' +
                k[1]);
            }
            if (k[0] === 'progress.completed') {
                $('#complete').html('<p>' + k[1].moduleName + '::' +
                  k[1].className + '::' + k[1].testName + '::' +
                  k[1].fixtureName + '::' + k[1].phase + '::' + k[1].outcome +
                  '</p>');

            }
          });
        }
      });
    });
  </script>

</html>
