<!doctype html>
<html>
  <head>
    <title>Test Session Main Page</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.js"></script>
  </head>

  <div id="container">
    <p id="sessionTitle">Session page placeholder</p>
    <p id="status">Status</p>
    <p id="activeSetups">Currently active setup functions: None</p>

    <div id="running">
      <p>Running:</p>
      <div>
        <p style="display: inline">Module: </p>
        <p id="module" style="display: inline">None</p>
      </div>
      <div>
        <p style="display: inline">Class: </p>
        <p id="class" style="display: inline">None</p>
      </div>
      <div>
        <p style="display: inline">Test function: </p>
        <p id="test" style="display: inline">None</p>
      </div>
      <div>
        <p style="display: inline">Phase: </p>
        <p id="phase" style="display: inline">None</p>
      </div>
    </div>
    <div id="complete" style="overflow-y: scroll; max-height: 50px"></div>
    <div id="testResults"></div>

    <ul id="testsList"></ul>
  </div>

  <script type="text/javascript">
    $(window).ready(function() {
      let socket = io();
      socket.on('connect', function () {
        console.log("Client connected");
        socket.emit('from', {page: 'session'});
      });

      socket.on('session_full', (data) => {
        console.log(data);
        console.log('Collected tests: ' + data.collected);
        console.log('Collected tests #: ' + data.collected.length);
        $('#sessionTitle').html('Session ' + data.sessionId + ' collected ' +
          data.collected.length + ' tests');
        $('#plan').html('Test plan: ' + data.plan);
        $('#status').html('Status: ' + data.status);

      });

      let moduleName = '';
      let className = '';
      let testName = '';

      socket.on('session_update', (data) => {
        if (data.hasOwnProperty('updatedFields')) {
          // TODO process this at the server end instead - just for array elements like runOrder
          Object.entries(data.updatedFields).forEach(function(k) {
            if (k[0].indexOf('runOrder') === 0) {
              // attribute starts with runOrder
              console.log(k);
              console.log("Found - " + k[0]);

              let re = /runOrder\.?(?<index>\d*)\.?(?<param>\w*)/gm;
              let my = re.exec(k[0]);
              console.log(my);
              let runOrderIndex = my.groups.index;
              let runOrderParam = my.groups.param;

              if (!runOrderIndex) {
                console.log('runOrder with no index detected - element 0');
                $('#module').text(k[1][0].moduleName);
                $('#class').text(k[1][0].className);
                $('#test').text(k[1][0].testName);
                runOrderIndex = 0;
                $('<li>', {
                  id: 'test_' + runOrderIndex
                }).append([
                  $('<p>', {
                    id: "name_" + runOrderIndex,
                    text: k[1][0].testName
                  }).css({
                    display: "inline"
                  }),
                  $('<p>', {
                    id: "outcome_" + runOrderIndex,
                    text: ":  " + k[1][0].outcome
                  }).css({
                    display: "inline"
                  })
                ]).appendTo($('#testsList'));
              } else if (runOrderParam) { // TODO param update to first test?
                console.log('runOrder ' + runOrderIndex + ' param update - ' +
                  runOrderParam + ': ' + k[1]);
                if (runOrderParam === "status" && k[1] === "complete") {
                  $('#outcome_' + runOrderIndex).css('font-weight', 'bold');
                } else {
                  $('#' + runOrderParam + "_" + runOrderIndex).text(':  ' +
                    k[1]);
                }
              } else {
                console.log('runOrder full update/insert for index ' +
                  runOrderIndex);

                $('#module').text(k[1].moduleName);
                $('#class').text(k[1].className);
                $('#test').text(k[1].testName);

                $('<li>', {
                  id: 'test_' + runOrderIndex
                }).append([
                  $('<p>', {
                    id: "name_" + runOrderIndex,
                    text: k[1].testName
                  }).css({
                    display: "inline"
                  }),
                  $('<p>', {
                    id: "outcome_" + runOrderIndex,
                    text: ":  " + k[1].outcome
                  }).css({
                    display: "inline"
                  })
                ]).appendTo($('#testsList'));
              }
            }
            if (k[0] === 'progress.phase') {
              $('#phase').text(k[1]);
            }
            if (k[0] === 'progress.completed') {
              console.log(k[1]);
              if (k[1].hasOwnProperty('moduleName')) {
                moduleName = k[1].moduleName;
              }
              if (k[1].hasOwnProperty('className')) {
                className = k[1].className;
              }
              if (k[1].hasOwnProperty('testName')) {
                testName = k[1].testName;
              }
              $('#complete').append('<p>' + moduleName + ' :: ' + className +
                ' :: ' + testName + ' :: ' +  k[1].fixtureName + ' :: ' +
                k[1].phase + ' :: ' + k[1].outcome + ' :: ' +
                k[1].verifications + '</p>');

              // Scroll to bottom
              let scrollH = $('#complete').prop('scrollHeight');
              console.log("Scroll height: " + scrollH);
              $('#complete').scrollTop(scrollH);
            }
          });
        }
      });
    });
  </script>

</html>
